<html>
    <head>
      <meta charset="UTF-8">
      <title>Chat</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/3.0.1/iconfont/material-icons.min.css">
      <link rel="stylesheet" href="index.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.0/socket.io.min.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </head>
<body>
    <div class="container">
        <div class="row no-gutters">
          <div class="col-md-4 border-right">
            <div class="settings-tray">
              <img class="profile-image" src="https://picsum.photos/100/100?id=0" alt="Profile img">
              <span class="settings-tray--right">
                <i class="material-icons">cached</i>
                <i class="material-icons">message</i>
                <i class="material-icons">menu</i>
              </span>
            </div>
            <div class="search-box">
              <div class="input-wrapper">
                <i class="material-icons">search</i>
                <input placeholder="Search here" type="text">
              </div>
            </div>
            <div class="vh-80 scroll_box" id="div_user_list">
            
            </div>
          </div>
          <div class="col-md-8">
            <div class="settings-tray">
                <div class="d-flex justify-content-between">
                <div class="friend-drawer no-gutters friend-drawer--grey">
                    <img class="profile-image" src="https://picsum.photos/100/100?id=7" alt="">
                    <div class="text">
                        <h6 id="current_chat_name">Robo Cop</h6>
                        <p class="text-muted">Chat something...</p>
                    </div>
                </div>
                <span class="settings-tray--right">
                    <i class="material-icons">cached</i>
                    <i class="material-icons">message</i>
                    <i class="material-icons">menu</i>
                  </span>
                </div>
            </div>
            <div class="chat-panel">
              <div class="chat-panel" id="current_chat_panel">
              </div>
              
              <div class="row">
                <div class="col-12">
                  <div class="chat-box-tray">
                    <i class="material-icons">sentiment_very_satisfied</i>
                    <input id="inputChat" placeholder="Type your message here..." autocomplete="off" />
                    <i class="material-icons" onclick="sendChat()">send</i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        const socket = io({
          auth: {
            token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo5OTk5OTksInJvbGUiOiJjcyIsImlhdCI6MTYzODg4NTkwOCwiZXhwIjoxNjQyODA5OTA4fQ.jnfKxpR0fxwdCg-rEqpJc1xIWNiaozEq4a0WkRGK624"
          }
        });

        var form = document.getElementById('formChat');
        
        var inputChat = document.getElementById('inputChat');
        function sendChat() {
          if(current_chat_user === undefined) {
            return;
          }

          
          if (inputChat.value) {
            socket.emit('chat', { msg: inputChat.value, receiverUserId: current_chat_user.id });
            inputChat.value = '';
          }
        }

        inputChat.addEventListener("keyup", function(event) {
          // Number 13 is the "Enter" key on the keyboard
          if (event.keyCode === 13) {
            // Cancel the default action, if needed
            event.preventDefault();
          }
        });
        
        function selectChatUser(userId, userName) {
          current_chat_user = {
            id: userId,
            name: userName,
          };

          $("#current_chat_name").text(userName);
        }

        var online_tickets = [];
        var current_chat_user;

        var pingSocketInterval;

        socket.on('connect', function() {
          socket.emit('open_chat_session', { name: "CS" });

          clearInterval(pingSocketInterval);
          pingSocketInterval = setInterval(function () {
            console.log("ping");
            socket.emit('ping');
          }, 5000);
        });

        socket.on('disconnect', function() {
          console.log("disconnect");
          clearInterval(pingSocketInterval);
        });

        socket.on('new_chats', function(msgs) {
          if(current_chat_user === undefined) {
            return;
          }
          console.log("new_chats: " + JSON.stringify(msgs));
          for (const msg of msgs) {
            console.log("msg: " + JSON.stringify(msg));
            console.log("current_chat_user: " + JSON.stringify(current_chat_user));
            if(current_chat_user.id == msg.receiverId) {
              $("#current_chat_panel").append(`<div class="row no-gutters">
                <div class="col-md-6">
                  <div class="chat-bubble chat-bubble--right">
                    ${msg.msg}
                  </div>
                </div>
              </div>`);
            } else if(current_chat_user.id == msg.senderId) {
              $("#current_chat_panel").append(`<div class="row no-gutters">
                <div class="col-md-6">
                  <div class="chat-bubble chat-bubble--left">
                    ${msg.msg}
                  </div>
                </div>
              </div>`);
            }
          }
        });
      
        socket.on('open_session_users', function(tickets) {
          $("#div_user_list").html("");
          console.log("open_session_users: " + JSON.stringify(tickets))
          online_tickets = [];
          for (const ticket of tickets) {
            online_tickets.push(ticket.userId);
            $("#div_user_list").append(`<div class="friend-drawer friend-drawer--onhover" onclick="selectChatUser(${ticket.userId}, '${ticket.userName}')">
            <img class="profile-image" src="https://picsum.photos/100/100?id=1" alt="">
            <div class="text">
              <h6>${ticket.userName}</h6>
              <p class="text-muted">Hi guy!</p>
            </div>
            <span class="time text-muted small">13:21</span>
          </div>
          <hr>`);
          } 
        });
      
        socket.on('add_chat_session_user', function(ticket) {
          var index = online_tickets.indexOf(ticket.userId);
          console.log("add_chat_session_user: " + JSON.stringify(ticket) + " index: " + index);

          
          if(index < 0) {
            online_tickets.push(ticket.userId);
            $("#div_user_list").append(`<div class="friend-drawer friend-drawer--onhover">
            <img class="profile-image" src="https://picsum.photos/100/100?id=1" alt="">
            <div class="text">
              <h6>${ticket.userName}</h6>
              <p class="text-muted">Hi guy!</p>
            </div>
            <span class="time text-muted small">13:21</span>
          </div>
          <hr>`);
          }
        });
      
        socket.on('remove_chat_session_user', function(ticket) {
          console.log("remove_chat_session_user: " + JSON.stringify(ticket))
        });
      </script>
</body>
</html>